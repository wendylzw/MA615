---
title: "hurricane mapping"
author: "Wendy Liang"
date: "2020/10/30"
output: 
  pdf_document: 
     latex_engine: xelatex
  html_document: default
---

```{r setup, include=FALSE,message=FALSE,warning=FALSE,fig.align='center'}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tmap)
library(sp)
library(sf)
library(hurricaneexposuredata)
library(maps)

```


## US County Map

- `county.fips` and `county`is in package `r maps`.  
- use `r left_join` to merge county's fips with its longitude and latitude

```{r}
data(county.fips)
uscounty=st_as_sf(map('county',plot=F,fill=T))

colnames(county.fips)[2]=colnames(uscounty)[1]
uscounty=left_join(uscounty,county.fips,'ID')
```


## Hurricane Data

- `r hurr_track` and `r rain` are from `r hurricaneexposuredata` package.  
- filter $Floyd-1999$ and $Allison-2000$ 

```{r message=FALSE, warning=FALSE}
####floyd####
hurr_floyd=hurr_tracks %>% filter(storm_id=='Floyd-1999')

rain_floyd=rain %>% filter(storm_id=='Floyd-1999')%>%
  group_by(fips)%>%
  summarise(storm_id=storm_id[1],precip=sum(precip))%>%
  mutate(fips=as.numeric(fips))%>%
  right_join(x=uscounty,by='fips')

####allison####
hurr_allison=hurr_tracks %>% filter(storm_id=='Allison-2001')

rain_allison=rain %>% filter(storm_id=='Allison-2001')%>%
  group_by(fips)%>%
  summarise(storm_id=storm_id[1],precip=sum(precip))%>%
  mutate(fips=as.numeric(fips)) %>%
  right_join(x=uscounty,by='fips')
```


## Mapping With `r ggplot2`

- `r geom_sf()`  for rain mapping  
- `r geom_path()` function for hurr_track mapping.

```{r}
gg_floyd=ggplot()+
  geom_sf(data=rain_floyd,mapping=aes(fill=precip))+
  scale_fill_steps(low="white",high="#0066FFFF",name='Rainfall (mm)',limits=c(0,250))+
  geom_path(hurr_floyd,mapping=aes(x=longitude,y=latitude),color="red")+
  xlim(-108, -65) + 
  ylim(23, 50) + 
  ggtitle("Floyd-1999")+
  theme(plot.title=element_text(hjust=0.5),
        panel.background=element_blank(),
        axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())


## filter allison dist<500 & rain>175
distance_allison=closest_dist %>% filter(storm_id=='Allison-2001',storm_dist<500)
rain_allison_need=rain_allison %>% filter(precip>175,fips %in% distance_allison$fips)

gg_allison=ggplot()+
  geom_sf(data=rain_allison,fill="white")+
  geom_sf(data=rain_allison_need,mapping=aes(fill=precip))+
  scale_fill_steps(low="white",high="#0066FFFF", name='Rainfall (mm)',guide = "colourbar",limits=c(0,250))+
  geom_path(data=hurr_allison,mapping=aes(x=longitude,y=latitude),color="red")+
  ggtitle("Allison-2001")+
  xlim(-108, -65) +
  ylim(23, 50) + 
  theme(plot.title=element_text(hjust=0.5),
        panel.background=element_blank(),
        panel.border=element_blank(),
        axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

gg_floyd
gg_allison

```


## Mapping with tmap

- `r tm_shape()` and `r tm_polygons()` for rain mapping  
- `r tm_lines()`  for hurr_track mapping
 
```{r}
hurr_floyd_need=SpatialLines(list(Lines(Line(cbind(hurr_floyd$longitude,hurr_floyd$latitude)),ID="Floyd-1999")))

hurr_allison_need=SpatialLines(list(Lines(Line(cbind(hurr_allison$longitude,hurr_allison$latitude)),ID="Allison-1999")))

## `tmaptools::palette_explorer()` can search the colours and give us codes!!! It's great!!
tm_floyd=tm_shape(rain_floyd)+
  tm_polygons(col='precip',title="Rainfall (mm)",palette = "Blues", n = 7,contrast = c(0, 0.91))+
  tm_legend(position=c("right","bottom"))+
  tm_shape(hurr_floyd_need)+
  tm_lines(col="red",lwd = 3)+
  tm_layout(main.title="Floyd-1999",
            main.title.position="center",
            frame = FALSE) 

tm_allison=tm_shape(rain_allison)+
  tm_polygons(col='precip',title="Rainfall (mm)",palette = "Blues", n = 7,contrast = c(0, 0.91))+
  tm_legend(position=c("right","bottom"))+
  tm_shape(hurr_allison_need)+
  tm_lines(col="red",lwd = 3)+
  tm_layout(main.title="Allison-2001",
            main.title.position="center",
            frame = FALSE) 

tm_floyd
tm_allison
```
